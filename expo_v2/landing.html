<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Expo Registration</title>

    <style>
        body {
            font-family: Poppins, sans-serif;
            background: linear-gradient(135deg, #004e92, #000428);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .box {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(12px);
            padding: 2rem 2.5rem;
            border-radius: 16px;
            width: 320px;
            text-align: center;
        }

        input {
            width: 100%;
            padding: 0.6rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            border: none;
            outline: none;
        }

        button {
            width: 100%;
            padding: 0.7rem;
            background: #00b4d8;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="box">
        <h2>Expo Registration</h2>

        <div id="step1">
            <input id="name" placeholder="Full Name">
            <input id="phone" placeholder="Phone Number">
            <button onclick="sendOTP()">Send OTP</button>
        </div>

        <div id="step2" style="display:none;">
            <input id="otp" placeholder="Enter OTP">
            <button onclick="verifyOTP()">Verify</button>
        </div>

    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        let CONFIG = {};

        async function loadConfig() {
            const res = await fetch("config.json");
            CONFIG = await res.json();

            window.supabase = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        }

        await loadConfig();

        let newUserID = null;
        let generatedOTP = null;

        // window.sendOTP = async () => {
        //     const name = document.getElementById("name").value.trim();
        //     const phone = document.getElementById("phone").value.trim();

        //     if (!name || !phone) {
        //         alert("Enter name and phone");
        //         return;
        //     }

        //     generatedOTP = Math.floor(1000 + Math.random() * 9000).toString();

        //     // INSERT new row for this user
        //     const { data, error } = await supabase
        //         .from("expo_v2")
        //         .insert([{
        //             full_name: name,
        //             phone_number: phone,
        //             otp_sent_time: new Date().toISOString()
        //         }])
        //         .select("id");

        //     if (error) {
        //         console.error(error);
        //         alert("Error saving entry");
        //         return;
        //     }

        //     newUserID = data[0].id;

        //     // alert("OTP Sent: " + generatedOTP);  // You will replace with SMS API
        //     // Call Supabase edge function
        //     await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/send-otp`, {
        //     method: "POST",
        //     headers: { "Content-Type": "application/json" },
        //     body: JSON.stringify({
        //         phone: phone,
        //         otp: generatedOTP
        //     })
        //     });

        //     // No need to show OTP now
        //     alert("OTP sent successfully!");

        //     document.getElementById("step1").style.display = "none";
        //     document.getElementById("step2").style.display = "block";
        // };

        window.sendOTP = async () => {
            const name = document.getElementById("name").value.trim();
            const phone = document.getElementById("phone").value.trim();

            if (!name || !phone) {
                alert("Enter name and phone");
                return;
            }

            generatedOTP = Math.floor(1000 + Math.random() * 9000).toString();

            // 1️⃣ Save initial entry in Supabase
            const { data, error } = await supabase
                .from("expo_v2")
                .insert([{
                    full_name: name,
                    phone_number: phone,
                    otp_sent_time: new Date().toISOString()
                }])
                .select("id");

            if (error) {
                alert("Error saving entry");
                return;
            }

            newUserID = data[0].id;

            // 2️⃣ Call Supabase Edge Function → MSG91
            await fetch("https://ycsyluapxpbtyroehpbf.supabase.co/functions/v1/send-otp", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
                },
                body: JSON.stringify({
                    phone: phone,
                    otp: generatedOTP
                })
            });


            if (!resp.ok) {
                alert("Failed to send OTP (SMS API error)");
                return;
            }

            alert("OTP sent via SMS!");

            document.getElementById("step1").style.display = "none";
            document.getElementById("step2").style.display = "block";
        };


        window.verifyOTP = async () => {
            const otp = document.getElementById("otp").value.trim();
            if (otp !== generatedOTP) {
                alert("Invalid OTP");
                return;
            }

            await supabase
                .from("expo_v2")
                .update({
                    otp_verified: true,
                    otp_verified_time: new Date().toISOString()
                })
                .eq("id", newUserID);

            window.location.href = `survey.html?id=${newUserID}`;
        };

    </script>

</body>

</html>